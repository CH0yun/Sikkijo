<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ê¸°ì¡° í¸ì„±ê¸°</title>

    <style>
        :root {
            --color-primary: #007bff; --color-secondary: #6c757d; --color-success: #28a745;
            --color-danger: #dc3545; --color-warning: #ffc107; --color-info: #17a2b8;
            --color-light: #f8f9fa; --color-dark: #343a40; --border-radius: 8px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; padding: 20px; background-color: var(--color-light); color: var(--color-dark);
            display: flex; flex-direction: column; align-items: center;
        }
        h1, h2 { color: var(--color-dark); text-align: center; }
        h3 { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .instructions-container { width: 100%; max-width: 1200px; margin-bottom: 20px; }
        .toggle-btn {
            width: 100%; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer;
            border: none; border-radius: var(--border-radius); color: white; text-align: center; margin-bottom: 10px;
        }
        .toggle-intro-btn { background-color: var(--color-info); }
        .toggle-instructions-btn { background-color: var(--color-success); }
        .collapsible-content {
            max-height: 0; overflow: hidden; background-color: #f8f9fa; border-radius: var(--border-radius);
            transition: max-height 0.5s ease-out; padding: 0 20px; border: 1px solid #e9ecef;
        }
        .collapsible-content.active { max-height: 800px; padding: 20px; }
        .collapsible-content h3 { margin-top: 0; }
        .collapsible-content ul, .collapsible-content ol { padding-left: 20px; line-height: 1.8; }
        .collapsible-content li strong { color: var(--color-primary); }
        .collapsible-content .caution { color: var(--color-danger); font-weight: bold; }
        .maker-credit { text-align: right; color: #888; font-size: 14px; margin-top: 15px; }

        .container {
            width: 100%; max-width: 1200px; background-color: white; padding: 25px;
            border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px; box-sizing: border-box;
        }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            border: 1px solid #dee2e6; padding: 12px; text-align: center;
            vertical-align: middle; white-space: nowrap; 
        }
        th { background-color: #e9ecef; }
        td input[type="number"], td input[type="text"] {
            width: 100%; box-sizing: border-box; text-align: center; border: 1px solid #ced4da;
            border-radius: 4px; padding: 8px; font-size: 16px;
        }
        
        #required-personnel-table th, #required-personnel-table td { min-width: 70px; }
        #member-info-table th:nth-child(1), #member-info-table td:nth-child(1) { min-width: 80px; }
        #member-info-table th:nth-child(2), #member-info-table td:nth-child(2) { min-width: 150px; }
        #member-info-table th:nth-child(3), #member-info-table td:nth-child(3) { min-width: 110px; }
        #member-info-table th:nth-child(4), #member-info-table td:nth-child(4) { min-width: 90px; }
        #member-info-table th:nth-child(5), #member-info-table td:nth-child(5) { min-width: 90px; }

        .total-cell { font-weight: bold; text-align: right; }
        .action-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        button {
            padding: 12px 20px; font-size: 16px; font-weight: bold; cursor: pointer;
            border: none; border-radius: var(--border-radius); color: white;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-add { background-color: var(--color-secondary); }
        .btn-schedule { background-color: var(--color-primary); }
        .btn-copy { background-color: var(--color-warning); color: var(--color-dark); }
        .btn-data { background-color: #545b62; }
        .btn-small { font-size: 14px; padding: 8px 12px; }
        .btn-exclusion { background-color: var(--color-success); }
        .btn-delete { background-color: var(--color-danger); }
        .output-cell { font-size: 14px; line-height: 1.6; min-width: 120px; }
        .output-cell .member { display: block; padding: 4px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .output-cell .member:active { cursor: grabbing; }
        .output-cell .excluded-list { margin-top: 8px; font-size: 12px; color: var(--color-primary); }
        .highlight { background-color: #fff3cd !important; }
        .summary-highlight { background-color: #fff3cd; border-radius: 4px; padding: 2px 4px; }
        .drag-over { background-color: #cce5ff; }
        #summary-cell { padding: 15px; text-align: left; white-space: normal; line-height: 1.8; font-size: 14px; }
        #summary-cell span { cursor: pointer; }
        
        /* â­ ë„ì›€ë§ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .help-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: var(--color-secondary);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            line-height: 20px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        /* ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ */
        @media print {
            body { padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .container { box-shadow: none; border: 1px solid #dee2e6; margin: 0; max-width: 100%; }
            h1, h2 { margin-top: 0; padding-top: 20px; }
        }
        
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 30px; border-radius: var(--border-radius);
            width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; }
        .close-button { font-size: 28px; font-weight: bold; cursor: pointer; }
        .exclusion-table .day-cell { cursor: pointer; }
        .exclusion-table .day-cell.excluded { background-color: var(--color-danger); color: white; }
        .exclusion-reason { margin-top: 5px; width: 100%; box-sizing: border-box; padding: 5px; border-radius: 4px; border: 1px solid #ced4da; }
    </style>
</head>
<body>
    <div class="instructions-container no-print">
        <button id="toggle-intro-btn" class="toggle-btn toggle-intro-btn">âœ¨ ì´ ì•±ì€ ë¬´ì—‡ì¸ê°€ìš”? (ì†Œê°œ)</button>
        <div id="intro-content" class="collapsible-content">
            <h3>ë‹¨ìˆœí•˜ê³  ê³µì •í•œ ìë™ í¸ì„± ì†”ë£¨ì…˜</h3>
            <p><strong>ì‹ê¸°ì¡° í¸ì„±ê¸°</strong>ëŠ” ë§¤ì£¼ ë°˜ë³µë˜ëŠ” ë²ˆê±°ë¡œìš´ ì‹ê¸°ì¡° í¸ì„± ì—…ë¬´ë¥¼ ë‹¨ í•œ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ í•´ê²°í•˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>
            <ul>
                <li><strong>ë¹ ë¥´ê³  ì •í™•í•œ í¸ì„±:</strong> ë³µì¡í•œ ì—´ì™¸ ì¡°ê±´ê³¼ ì¸ì›ë³„ íšŸìˆ˜ë¥¼ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ ìˆ˜ ì´ˆ ë‚´ì— ìµœì ì˜ í¸ì„±í‘œë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.</li>
                <li><strong>ê³µì •í•œ ë¶„ë°°:</strong> íŠ¹ì •ì¸ì—ê²Œ ê·¼ë¬´ê°€ í¸ì¤‘ë˜ì§€ ì•Šë„ë¡ ì¡°ì‹/ì¤‘ì‹/ì„ì‹ ê·¼ë¬´ë¥¼ ìµœëŒ€í•œ ê³µí‰í•˜ê²Œ ë¶„ë°°í•©ë‹ˆë‹¤.</li>
                <li><strong>í¸ë¦¬í•œ ê´€ë¦¬ ë° ìˆ˜ì •:</strong> í¸ì„± í›„ ê²°ê³¼ë¥¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì‰½ê²Œ ìˆ˜ì •í•˜ê³ , ì¸ì› ëª©ë¡ì„ ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li><strong>'ë¸ŒëŸ°ì¹˜ ë°ì´' ì ìš©:</strong> í† ìš”ì¼ ì ì‹¬ì€ ì‹ê¸°ì¡°ê°€ ì—†ëŠ” 'ë¸ŒëŸ°ì¹˜ ë°ì´'ê°€ ê¸°ë³¸ê°’(0ëª…)ìœ¼ë¡œ ë°˜ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ì¸ì›ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
            <p class="maker-credit">made by ì±„ì˜ìœ¤(25.4)</p>
        </div>
        <button id="toggle-instructions-btn" class="toggle-btn toggle-instructions-btn">ğŸ’¡ ì‚¬ìš©ë°©ë²• ë³´ê¸°</button>
        <div id="instructions-content" class="collapsible-content">
             <h3>ì‹ê¸°ì¡° í¸ì„±ê¸° ì‚¬ìš©ë²•</h3>
            <ol>
                <li><strong>ë°ì´í„° ê´€ë¦¬:</strong> `ğŸ’¾ ì €ì¥` ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ ì¸ì› ëª©ë¡ê³¼ í•„ìš”ì¸ì› ì„¤ì •ì„ ì €ì¥í•˜ê³ , `ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°`ë¡œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li><strong>ì •ë³´ ì…ë ¥:</strong> ê³„ê¸‰, ì´ë¦„, íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ê³  `+ ì¸ì› ì¶”ê°€`, `ì‚­ì œ` ë²„íŠ¼ìœ¼ë¡œ ì¸ì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
                <li><strong>í¸ì„± ì‹œì‘:</strong> `ğŸš€ í¸ì„± ì‹œì‘` ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li>
                <li><strong>ê²°ê³¼ í™•ì¸ ë° ìˆ˜ì •:</strong>
                    <ul>
                        <li><strong>í•˜ì´ë¼ì´íŠ¸:</strong> ê²°ê³¼í‘œë‚˜ í•˜ë‹¨ ìš”ì•½ ì¤„ì˜ íŠ¹ì • ì¸ì›ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¸ì›ì˜ ëª¨ë“  ê·¼ë¬´ ì‹œê°„ì´ ê°•ì¡° í‘œì‹œë©ë‹ˆë‹¤.</li>
                        <li><strong>ìˆ˜ë™ ìˆ˜ì •:</strong> ì¸ì› ì´ë¦„ì„ ë§ˆìš°ìŠ¤ë¡œ ëŒì–´ ë‹¤ë¥¸ ì¹¸ìœ¼ë¡œ ì˜®ê²¨(ë“œë˜ê·¸ ì•¤ ë“œë¡­) í¸ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì—´ì™¸ ì‹œê°„ì—ëŠ” ì´ë™ ë¶ˆê°€)</li>
                    </ul>
                </li>
                <li><strong>ê³µìœ  ë° ì¸ì‡„:</strong> `í…ìŠ¤íŠ¸/í‘œ ë³µì‚¬` ë˜ëŠ” `ğŸ–¨ï¸ ì¸ì‡„` ë²„íŠ¼ìœ¼ë¡œ ê²°ê³¼ë¥¼ ê³µìœ í•˜ê±°ë‚˜ ì¶œë ¥í•©ë‹ˆë‹¤.</li>
            </ol>
            <h3 class="caution">âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
            <ul>
                <li><strong>'ì´ í•„ìš”ì¸ì›'</strong>ê³¼ <strong>'ì´ íšŸìˆ˜ í•©ê³„'</strong>ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í•­ìƒ í™•ì¸í•´ì£¼ì„¸ìš”.</li>
                <li>í¸ì„± ì‹œì‘ ì „, ëª¨ë“  ì¸ì›ì˜ <strong>ì´ë¦„ì´ ë¹„ì–´ìˆê±°ë‚˜ ì¤‘ë³µë˜ì§€ ì•Šì•˜ëŠ”ì§€</strong> í™•ì¸í•´ì£¼ì„¸ìš”.</li>
            </ul>
        </div>
    </div>
    
    <h1>ğŸ½ï¸ ì‹ê¸°ì¡° í¸ì„±ê¸°</h1>

    <div class="container">
        <div class="action-buttons no-print">
            <button class="btn-data" onclick="saveData()">ğŸ’¾ ì €ì¥</button>
            <button class="btn-data" onclick="loadData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <h2 class="no-print">1. ì •ë³´ ì…ë ¥</h2>
        <h3 class="no-print">ì‹œê°„ë³„ í•„ìš”ì¸ì›</h3>
        <div class="table-container no-print">
            <table id="required-personnel-table"></table>
        </div>
        <h3 class="no-print">ì¸ì› ì •ë³´</h3>
        <div class="table-container no-print">
            <table id="member-info-table">
                <thead>
                    <tr><th>ê³„ê¸‰</th><th>ì´ë¦„</th><th>ì‹ê¸°ì¡° íšŸìˆ˜</th><th>ì—´ì™¸ ì„¤ì •</th><th>ì‚­ì œ</th></tr>
                </thead>
                <tbody></tbody>
                 <tfoot><tr><td class="total-cell" colspan="2">ì´ íšŸìˆ˜ í•©ê³„:</td><td colspan="3" id="total-duties">0</td></tr></tfoot>
            </table>
        </div>
        <div class="action-buttons no-print">
            <button class="btn-add" onclick="addMember()">+ ì¸ì› ì¶”ê°€</button>
            <button class="btn-schedule" onclick="runScheduler()">ğŸš€ í¸ì„± ì‹œì‘</button>
        </div>
    </div>
    <div class="container">
        <h2>2. í¸ì„± ê²°ê³¼ <span class="help-icon no-print" onclick="alert('ê²°ê³¼í‘œì˜ ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¸ì›ì˜ ëª¨ë“  ê·¼ë¬´ê°€ ê°•ì¡° í‘œì‹œë©ë‹ˆë‹¤. \nì´ë¦„ì„ ë“œë˜ê·¸í•˜ì—¬ ë‹¤ë¥¸ ì¹¸ìœ¼ë¡œ ì˜®ê²¨ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.')">â“˜</span></h2>
        <div class="table-container">
            <table id="output-table">
                 <thead><tr><th>@</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th></tr></thead>
                 <tbody></tbody>
                 <tfoot>
                    <tr>
                        <td id="summary-cell" colspan="8">í¸ì„± í›„ ì´ê³³ì— ì¸ì›ë³„ íšŸìˆ˜ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</td>
                    </tr>
                 </tfoot>
            </table>
        </div>
        <div class="action-buttons no-print">
            <button class="btn-copy" onclick="copyAsText()">ğŸ“„ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬</button>
            <button class="btn-copy" onclick="copyAsTable()">ğŸ“‹ í‘œ(ì—‘ì…€)ë¡œ ë³µì‚¬</button>
            <button class="btn-data" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
        </div>
    </div>
    
    <div id="exclusion-modal" class="modal no-print"></div>

    <script>
        let memberData = [];
        let memberIdCounter = 0;
        let lastScheduleData = null;

        document.addEventListener('DOMContentLoaded', () => {
            const toggleIntroBtn = document.getElementById('toggle-intro-btn');
            const introContent = document.getElementById('intro-content');
            toggleIntroBtn.addEventListener('click', () => {
                const isActive = introContent.classList.toggle('active');
                toggleIntroBtn.textContent = isActive ? 'ğŸ˜Š ì•± ì†Œê°œ ë‹«ê¸°' : 'âœ¨ ì´ ì•±ì€ ë¬´ì—‡ì¸ê°€ìš”? (ì†Œê°œ)';
            });
            const toggleInstructionsBtn = document.getElementById('toggle-instructions-btn');
            const instructionsContent = document.getElementById('instructions-content');
            toggleInstructionsBtn.addEventListener('click', () => {
                const isActive = instructionsContent.classList.toggle('active');
                toggleInstructionsBtn.textContent = isActive ? 'ğŸ‘ ì‚¬ìš©ë°©ë²• ìˆ¨ê¸°ê¸°' : 'ğŸ’¡ ì‚¬ìš©ë°©ë²• ë³´ê¸°';
            });
            
            document.getElementById('required-personnel-table').innerHTML = `<thead><tr><th>@</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th></tr></thead><tbody><tr><td>ì¡°ì‹</td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td></tr><tr><td>ì¤‘ì‹</td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="0" min="0"></td><td><input type="number" value="3" min="0"></td></tr><tr><td>ì„ì‹</td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td><td><input type="number" value="3" min="0"></td></tr></tbody><tfoot><tr><td colspan="8" class="total-cell">ì´ í•„ìš”ì¸ì›: <span id="total-required">60</span></td></tr></tfoot>`;
            document.getElementById('output-table').querySelector('tbody').innerHTML = `<tr><td>ì¡°ì‹</td><td data-time="0" data-day="0"></td><td data-time="0" data-day="1"></td><td data-time="0" data-day="2"></td><td data-time="0" data-day="3"></td><td data-time="0" data-day="4"></td><td data-time="0" data-day="5"></td><td data-time="0" data-day="6"></td></tr><tr><td>ì¤‘ì‹</td><td data-time="1" data-day="0"></td><td data-time="1" data-day="1"></td><td data-time="1" data-day="2"></td><td data-time="1" data-day="3"></td><td data-time="1" data-day="4"></td><td data-time="1" data-day="5"></td><td data-time="1" data-day="6"></td></tr><tr><td>ì„ì‹</td><td data-time="2" data-day="0"></td><td data-time="2" data-day="1"></td><td data-time="2" data-day="2"></td><td data-time="2" data-day="3"></td><td data-time="2" data-day="4"></td><td data-time="2" data-day="5"></td><td data-time="2" data-day="6"></td></tr>`;
            document.getElementById('exclusion-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="modal-title"></h3><span class="close-button" onclick="closeModal()">&times;</span></div><table class="exclusion-table"><thead><tr><th>@</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th></tr></thead><tbody><tr><td>ì¡°ì‹</td><td class="day-cell" data-time="0" data-day="0"></td><td class="day-cell" data-time="0" data-day="1"></td><td class="day-cell" data-time="0" data-day="2"></td><td class="day-cell" data-time="0" data-day="3"></td><td class="day-cell" data-time="0" data-day="4"></td><td class="day-cell" data-time="0" data-day="5"></td><td class="day-cell" data-time="0" data-day="6"></td></tr><tr><td>ì¤‘ì‹</td><td class="day-cell" data-time="1" data-day="0"></td><td class="day-cell" data-time="1" data-day="1"></td><td class="day-cell" data-time="1" data-day="2"></td><td class="day-cell" data-time="1" data-day="3"></td><td class="day-cell" data-time="1" data-day="4"></td><td class="day-cell" data-time="1" data-day="5"></td><td class="day-cell" data-time="1" data-day="6"></td></tr><tr><td>ì„ì‹</td><td class="day-cell" data-time="2" data-day="0"></td><td class="day-cell" data-time="2" data-day="1"></td><td class="day-cell" data-time="2" data-day="2"></td><td class="day-cell" data-time="2" data-day="3"></td><td class="day-cell" data-time="2" data-day="4"></td><td class="day-cell" data-time="2" data-day="5"></td><td class="day-cell" data-time="2" data-day="6"></td></tr></tbody></table></div>`;
            
            if (localStorage.getItem('sikgijoData')) {
                loadData();
            } else {
                for (let i = 0; i < 8; i++) { addMember(true); }
                autoSetDuties();
            }
            const requiredInputs = document.querySelectorAll('#required-personnel-table input');
            requiredInputs.forEach(input => input.addEventListener('input', updateTotalRequired));
            updateTotalRequired();
            
            setupOutputTableInteractions();
            document.getElementById('summary-cell').addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    highlightMember(e.target.dataset.name);
                }
            });
        });

        function autoSetDuties() {
            const totalRequired = Array.from(document.querySelectorAll('#required-personnel-table input')).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
            const numMembers = memberData.length;
            if (numMembers === 0) return;
            const baseDuties = Math.floor(totalRequired / numMembers);
            const remainder = totalRequired % numMembers;
            memberData.forEach((member, index) => {
                member.duties = baseDuties + (index < remainder ? 1 : 0);
            });
            renderMemberTable();
            updateTotals();
        }
        
        function saveData() {
            const requiredPersonnelValues = Array.from(document.querySelectorAll('#required-personnel-table input')).map(input => input.value);
            const serializableMemberData = memberData.map(m => ({
                ...m,
                exclusions: Array.from(m.exclusions.entries())
            }));
            const dataToSave = { members: serializableMemberData, required: requiredPersonnelValues };
            localStorage.setItem('sikgijoData', JSON.stringify(dataToSave));
            alert('í˜„ì¬ ìƒíƒœê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function loadData() {
            const savedData = JSON.parse(localStorage.getItem('sikgijoData'));
            if (!savedData) {
                alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            memberData = savedData.members.map(m => ({ ...m, exclusions: new Map(m.exclusions) }));
            memberIdCounter = memberData.length > 0 ? Math.max(...memberData.map(m => m.id)) + 1 : 0;
            const requiredInputs = document.querySelectorAll('#required-personnel-table input');
            savedData.required.forEach((val, index) => {
                if(requiredInputs[index]) requiredInputs[index].value = val;
            });
            renderMemberTable();
            updateTotals();
            alert('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }
        
        function renderMemberTable() {
            const tableBody = document.querySelector('#member-info-table tbody');
            tableBody.innerHTML = '';
            memberData.forEach(member => {
                 const newRow = tableBody.insertRow();
                newRow.id = `member-row-${member.id}`;
                newRow.innerHTML = `<td><input type="number" value="${member.rank}" min="1" max="4" oninput="updateMember(${member.id}, 'rank', this.value)"></td><td><input type="text" value="${member.name}" placeholder="ì´ë¦„ ì…ë ¥" onchange="updateMember(${member.id}, 'name', this.value)"></td><td><input type="number" value="${member.duties}" min="0" oninput="updateMember(${member.id}, 'duties', this.value)"></td><td><button class="btn-exclusion btn-small" onclick="openModal(${member.id})">ì„¤ì •</button></td><td><button class="btn-delete btn-small" onclick="deleteMember(${member.id})">ì‚­ì œ</button></td>`;
            });
        }
        
        function highlightMember(memberName) {
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            document.querySelectorAll('.summary-highlight').forEach(el => el.classList.remove('summary-highlight'));
            
            if (memberName) {
                document.querySelectorAll(`.member[data-name="${memberName}"]`).forEach(el => el.classList.add('highlight'));
                const summarySpan = document.querySelector(`#summary-cell span[data-name="${memberName}"]`);
                if(summarySpan) summarySpan.classList.add('summary-highlight');
            }
        }
        
        function setupOutputTableInteractions() {
            const outputTable = document.getElementById('output-table');
            let draggedItem = null;
            outputTable.addEventListener('click', (e) => {
                if (e.target.classList.contains('member')) {
                    highlightMember(e.target.dataset.name);
                }
            });
            outputTable.addEventListener('dragstart', (e) => { if (e.target.classList.contains('member')) { draggedItem = e.target; setTimeout(() => e.target.style.opacity = '0.5', 0); } });
            outputTable.addEventListener('dragend', (e) => { if (draggedItem) { draggedItem.style.opacity = '1'; draggedItem = null; } });
            outputTable.addEventListener('dragover', (e) => { e.preventDefault(); const targetCell = e.target.closest('td[data-time]'); if (targetCell) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); targetCell.classList.add('drag-over'); } });
            outputTable.addEventListener('dragleave', (e) => { const targetCell = e.target.closest('td[data-time]'); if (targetCell) { targetCell.classList.remove('drag-over'); } });
            outputTable.addEventListener('drop', (e) => {
                e.preventDefault();
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                const targetCell = e.target.closest('td[data-time]');
                if (targetCell && draggedItem) {
                    const memberName = draggedItem.dataset.name;
                    const member = memberData.find(m => m.name === memberName);
                    const targetKey = `${targetCell.dataset.time}-${targetCell.dataset.day}`;
                    if (member && member.exclusions.has(targetKey)) { alert(`${memberName}ë‹˜ì€ í•´ë‹¹ ì‹œê°„ì— ì—´ì™¸ë¡œ ì„¤ì •ë˜ì–´ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }
                    const sourceCell = draggedItem.parentElement;
                    const sourceKey = `${sourceCell.dataset.time}-${sourceCell.dataset.day}`;
                    const sourceTime = sourceKey.split('-')[0], sourceDay = sourceKey.split('-')[1];
                    lastScheduleData[sourceTime][sourceDay] = lastScheduleData[sourceTime][sourceDay].filter(name => name !== memberName);
                    const targetTime = targetKey.split('-')[0], targetDay = targetKey.split('-')[1];
                    lastScheduleData[targetTime][targetDay].push(memberName);
                    renderSchedule(lastScheduleData);
                }
            });
        }
        
        function addMember(isInitial = false) {
            const newId = memberIdCounter++;
            const newMember = { id: newId, rank: 1, name: '', duties: 0, exclusions: new Map() };
            memberData.push(newMember);
            if (!isInitial) { renderMemberTable(); updateTotals(); }
        }
        
        function renderSchedule(schedule) {
            document.querySelectorAll('#output-table td[data-time]').forEach(cell => {
                cell.innerHTML = '';
                const time = cell.dataset.time, day = cell.dataset.day;
                const scheduledMembers = schedule[time][day] || [];
                scheduledMembers.forEach(name => {
                    const member = memberData.find(m => m.name === name);
                    if (!member) return;
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'member';
                    memberDiv.textContent = `${getRankSymbol(member.rank)}${member.name}`;
                    memberDiv.dataset.name = name;
                    memberDiv.draggable = true;
                    cell.appendChild(memberDiv);
                });
                const excludedInThisSlot = memberData.filter(m => m.name && m.exclusions.has(`${time}-${day}`));
                if (excludedInThisSlot.length > 0) {
                    const excludedDiv = document.createElement('div');
                    excludedDiv.className = 'excluded-list';
                    excludedDiv.textContent = `(ì—´ì™¸: ${excludedInThisSlot.map(m => `${m.name}(${m.exclusions.get(`${time}-${day}`)})`).join(', ')})`;
                    cell.appendChild(excludedDiv);
                }
            });
        }
        
        function renderSummary() {
            const summaryCell = document.getElementById('summary-cell');
            summaryCell.innerHTML = ''; // Clear previous summary
            const summarySpans = memberData.filter(m => m.name).map(m => {
                const span = document.createElement('span');
                span.dataset.name = m.name;
                span.textContent = `${getRankSymbol(m.rank)}${m.name}(${m.duties})`;
                return span;
            });
            summarySpans.forEach((span, index) => {
                summaryCell.appendChild(span);
                if (index < summarySpans.length - 1) {
                    summaryCell.appendChild(document.createTextNode(', '));
                }
            });
            if (summarySpans.length === 0) {
                summaryCell.textContent = 'í¸ì„± í›„ ì´ê³³ì— ì¸ì›ë³„ íšŸìˆ˜ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.';
            }
        }
        
        // --- ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ ---
        let currentEditingMemberId = null;
        function openModal(id) { currentEditingMemberId = id; const member = memberData.find(m => m.id === id); if (!member) return; document.getElementById('modal-title').textContent = `${member.name || 'ì´ë¦„ ì—†ëŠ” ì¸ì›'} ì—´ì™¸ ì„¤ì •`; const modal = document.getElementById('exclusion-modal'); modal.querySelectorAll('.day-cell').forEach(cell => { const key = `${cell.dataset.time}-${cell.dataset.day}`; const existingReasonInput = cell.querySelector('.exclusion-reason'); if (existingReasonInput) existingReasonInput.remove(); if (member.exclusions.has(key)) { cell.classList.add('excluded'); cell.innerHTML = 'â—'; const reasonInput = document.createElement('input'); reasonInput.type = 'text'; reasonInput.className = 'exclusion-reason'; reasonInput.placeholder = 'ì‚¬ìœ  ì…ë ¥'; reasonInput.value = member.exclusions.get(key); reasonInput.onclick = (e) => e.stopPropagation(); reasonInput.onchange = (e) => { member.exclusions.set(key, e.target.value); }; cell.appendChild(reasonInput); } else { cell.classList.remove('excluded'); cell.textContent = 'â—‹'; } }); modal.style.display = 'flex'; }
        document.getElementById('exclusion-modal').addEventListener('click', (event) => { if (!event.target.classList.contains('day-cell')) return; if (currentEditingMemberId === null) return; const member = memberData.find(m => m.id === currentEditingMemberId); if (!member) return; const cell = event.target; const key = `${cell.dataset.time}-${cell.dataset.day}`; if (member.exclusions.has(key)) { member.exclusions.delete(key); const reasonInput = cell.querySelector('.exclusion-reason'); if (reasonInput) reasonInput.remove(); cell.classList.remove('excluded'); cell.textContent = 'â—‹'; } else { const reason = prompt("ì—´ì™¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì·¨ì†Œ ì‹œ 'ì—´ì™¸'):", "ì—´ì™¸"); if (reason === null) return; member.exclusions.set(key, reason); openModal(currentEditingMemberId); } });
        function deleteMember(id) { const memberIndex = memberData.findIndex(m => m.id === id); if (memberIndex === -1) return; if (confirm(`'${memberData[memberIndex].name || 'ì´ë¦„ ì—†ëŠ” ì¸ì›'}' ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { memberData.splice(memberIndex, 1); renderMemberTable(); updateTotals(); } }
        function updateMember(id, field, value) { const member = memberData.find(m => m.id === id); if (!member) return; if (field === 'rank' || field === 'duties') { member[field] = parseInt(value, 10) || 0; } else if (field === 'name') { member[field] = value.trim(); } if(field === 'duties') updateTotals(); }
        function getRankSymbol(rank) { switch(parseInt(rank, 10)) { case 1: return '_1'; case 2: return '_2'; case 3: return '_3'; case 4: return '_4'; default: return ''; } }
        function updateTotals() { const totalDuties = memberData.reduce((sum, m) => sum + m.duties, 0); document.getElementById('total-duties').textContent = totalDuties; updateTotalRequired(); }
        function updateTotalRequired() { const requiredInputs = document.querySelectorAll('#required-personnel-table input'); const totalRequired = Array.from(requiredInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0); document.getElementById('total-required').textContent = totalRequired; }
        function closeModal() { document.getElementById('exclusion-modal').style.display = 'none'; currentEditingMemberId = null; }
        window.onclick = function(event) { if (event.target == document.getElementById('exclusion-modal')) closeModal(); }
        function runScheduler() { const names = memberData.map(m => m.name).filter(name => name); if (names.length !== memberData.length) { alert("ì´ë¦„ì´ ë¹„ì–´ìˆëŠ” ì¸ì›ì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ì¸ì›ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } if (new Set(names).size !== names.length) { alert("ì¤‘ë³µëœ ì´ë¦„ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¦„ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”."); return; } const requiredPersonnel = Array.from(document.querySelectorAll('#required-personnel-table tbody tr')).map(row => Array.from(row.querySelectorAll('input')).map(input => parseInt(input.value, 10) || 0)); const totalRequired = requiredPersonnel.flat().reduce((sum, val) => sum + val, 0); const totalDuties = memberData.reduce((sum, m) => sum + m.duties, 0); if (totalDuties < totalRequired) { alert(`ì „ì²´ ì‹ê¸°ì¡° íšŸìˆ˜(${totalDuties})ê°€ í•„ìš” ì¸ì›(${totalRequired})ë³´ë‹¤ ì ìŠµë‹ˆë‹¤. ì¼ì¹˜í•˜ë„ë¡ ì¡°ì ˆí•´ì£¼ì„¸ìš”.`); return; } for (let time = 0; time < 3; time++) { for (let day = 0; day < 7; day++) { const required = requiredPersonnel[time][day]; const availableMembers = memberData.filter(m => !m.exclusions.has(`${time}-${day}`)); if (availableMembers.length < required) { const timeMap = ['ì¡°ì‹', 'ì¤‘ì‹', 'ì„ì‹'], dayMap = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']; alert(`${dayMap[day]}ìš”ì¼ ${timeMap[time]}ì— ê°€ìš© ì¸ì›(${availableMembers.length}ëª…)ì´ í•„ìš” ì¸ì›(${required}ëª…)ë³´ë‹¤ ì ì–´ í¸ì„±ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`); return; } } } let schedule = Array.from({ length: 3 }, () => Array.from({ length: 7 }, () => [])); let membersToSchedule = memberData.map(m => ({ ...m, dutiesLeft: m.duties, mealCounts: { 0: 0, 1: 0, 2: 0 } })); let slotsToFill = []; for (let time = 0; time < 3; time++) { for (let day = 0; day < 7; day++) { for (let i = 0; i < requiredPersonnel[time][day]; i++) { slotsToFill.push({ time, day }); } } } slotsToFill.sort(() => Math.random() - 0.5); for (const slot of slotsToFill) { membersToSchedule.sort((a, b) => { if (b.dutiesLeft !== a.dutiesLeft) return b.dutiesLeft - a.dutiesLeft; if (a.mealCounts[slot.time] !== b.mealCounts[slot.time]) return a.mealCounts[slot.time] - b.mealCounts[slot.time]; return Math.random() - 0.5; }); for (const member of membersToSchedule) { if (member.dutiesLeft > 0 && !member.exclusions.has(`${slot.time}-${slot.day}`) && !schedule[slot.time][slot.day].includes(member.name)) { schedule[slot.time][slot.day].push(member.name); member.dutiesLeft--; member.mealCounts[slot.time]++; break; } } } lastScheduleData = schedule; renderSchedule(schedule); renderSummary(); alert("í¸ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { alert("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }, () => { alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }); }
        function copyAsText() { if (!lastScheduleData) { alert("ë¨¼ì € í¸ì„±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”."); return; } const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']; const times = ['ì¡°ì‹', 'ì¤‘ì‹', 'ì„ì‹']; let textOutput = ''; days.forEach((day, dayIndex) => { textOutput += `[${day}]\n`; times.forEach((time, timeIndex) => { const members = lastScheduleData[timeIndex][dayIndex] || []; const excluded = memberData.filter(m => m.name && m.exclusions.has(`${timeIndex}-${dayIndex}`)); const memberNamesWithRank = members.map(name => { const member = memberData.find(m => m.name === name); return member ? `${getRankSymbol(member.rank)}${member.name}` : name; }); textOutput += `${time} | ${memberNamesWithRank.join(' ')}\n`; if (excluded.length > 0) { textOutput += `(ì—´ì™¸: ${excluded.map(m => `${m.name}(${m.exclusions.get(`${timeIndex}-${dayIndex}`)})`).join(' ')})\n`; } }); textOutput += '\n'; }); copyToClipboard(textOutput.trim()); }
        function copyAsTable() { if (!lastScheduleData) { alert("ë¨¼ì € í¸ì„±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”."); return; } const times = ['ì¡°ì‹', 'ì¤‘ì‹', 'ì„ì‹']; let tableText = ' \tì›”\tí™”\tìˆ˜\tëª©\tê¸ˆ\tí† \tì¼\n'; times.forEach((time, timeIndex) => { tableText += `${time}\t`; for (let dayIndex = 0; dayIndex < 7; dayIndex++) { const members = lastScheduleData[timeIndex][dayIndex] || []; const memberNamesWithRank = members.map(name => { const member = memberData.find(m => m.name === name); return member ? `${getRankSymbol(member.rank)}${member.name}` : name; }); tableText += `${memberNamesWithRank.join(', ')}\t`; } tableText += '\n'; }); copyToClipboard(tableText.trim()); }
    </script>
</body>
</html>
